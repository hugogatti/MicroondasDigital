@page "/microondas"
@using MicroondasDigital.Business.Interfaces
@using System.Text
@inject IMicroondasService MicroondasService

<h3>Micro-ondas Web</h3>

<div class="container">
    <div class="visor @AcendeVisor"></div>
    <div class="microondas-panel">
        <!-- Display de Tempo -->
        <div class="display">
            <p>@DisplayTexto</p>
        </div>

        <!-- Teclado Digital -->
        <div class="teclado">
            @foreach (var i in Enumerable.Range(1, 9))
            {
                <button @onclick="() => AdicionarNumero(i.ToString())" class="tecla">@i</button>
            }
            <button @onclick="MudarPotencia" class="teclaPotencia">P</button>
            <button @onclick='() => AdicionarNumero("0")' class="tecla">0</button>
            <button @onclick="LimparTempo" class="tecla">C</button>
            <button @onclick="IniciarAquecimento" class="teclaIniciar">Iniciar</button>
            <button @onclick="PausarOuCancelarAquecimento" class="teclaParaCanc">@TextoBotaoPausarCancelar</button>
        </div>

        <p>@EstadoAquecimento</p>
        <p>@ProcessoAquecimento</p>
    </div>
</div>

@code {
    private string TempoAtual { get; set; } = "0000"; // Armazenando tempo no formato MMSS
    private int Potencia { get; set; } = 10;
    private bool ExibirPotencia { get; set; } = false;
    private string EstadoAquecimento { get; set; } = "Aguardando início...";
    private bool EmAquecimento { get; set; } = false;
    private bool Pausado { get; set; } = false;
    private string AcendeVisor { get; set; } = "visor-inativo";
    private System.Timers.Timer? Timer;
    private StringBuilder ProcessoAquecimentoSB = new StringBuilder();

    private string ProcessoAquecimento => ProcessoAquecimentoSB.ToString();
    private string TextoBotaoPausarCancelar => Pausado ? "Cancelar" : "Pausar";

    // Método para determinar o que exibir no display (tempo ou potência)
    private string DisplayTexto => ExibirPotencia ? $"P {Potencia}" : TempoAtual.Insert(2, ":");

    // Iniciar o aquecimento e a contagem regressiva
    private async Task IniciarAquecimento()
    {
        if (EmAquecimento == true)
        {
            // acrescenta 30 segundos, mas não ultrapassa 120 segundos
            int tempoAtualizado = ConverterTempoEmSegundos() + 30;
            if (tempoAtualizado > 120)
            {
                EstadoAquecimento = "O tempo máximo permitido é 2 minutos.";
                return;
            }
            TempoAtual = ConverterSegundosParaTempo(tempoAtualizado);
            EstadoAquecimento = "Tempo aumentado em 30 segundos!";
            return;
        }

        int tempoTotal = ConverterTempoEmSegundos();
        if (tempoTotal == 0)
        {
            tempoTotal = 30;
            Potencia = 10;
            TempoAtual = "0030";
        }

        // Validar tempo antes de iniciar
        if (tempoTotal < 1 || tempoTotal > 120)
        {
            EstadoAquecimento = "O tempo deve estar entre 1 segundo e 2 minutos.";
            return;
        }

        EstadoAquecimento = await MicroondasService.IniciarAquecimento(tempoTotal, Potencia);
        EmAquecimento = true;
        Pausado = false;
        ExibirPotencia = false;
        ProcessoAquecimentoSB.Clear();

        Timer = new System.Timers.Timer(1000);
        Timer.Elapsed += async (sender, e) => await AtualizarContagem();
        Timer.AutoReset = true;
        EstadoAquecimento = "Aquecendo...";
        Timer.Start();
        AcendeVisor = "visor-ativo";
    }

    // Botão que alterna entre Pausar e Cancelar
    private async Task PausarOuCancelarAquecimento()
    {
        // Para pausar o aquecimento
        if (EmAquecimento && !Pausado)
        {
            Timer?.Stop();
            AcendeVisor = "visor-inativo";
            Pausado = true;
            EstadoAquecimento = "Aquecimento pausado";
            await MicroondasService.PausarAquecimento();
        }
        // Cancelar o aquecimento
        else if (Pausado)
        {
            Timer?.Stop();
            AcendeVisor = "visor-inativo";
            EmAquecimento = false;
            Pausado = false;
            TempoAtual = "0000";
            EstadoAquecimento = await MicroondasService.CancelarAquecimento();
        }
    }

    // Atualizar a contagem regressiva
    private async Task AtualizarContagem()
    {
        if (Pausado) return;

        int segundosRestantes = ConverterTempoEmSegundos();
        if (segundosRestantes == 0)
        {
            Timer?.Stop();
            AcendeVisor = "visor-inativo";
            EmAquecimento = false;
            EstadoAquecimento = "Aquecimento concluído!";
            ProcessoAquecimentoSB.Append(" Aquecimento concluído.");
            await InvokeAsync(StateHasChanged);
            return;
        }

        TempoAtual = ConverterSegundosParaTempo(segundosRestantes - 1);
        // Atualizar a string de aquecimento
        ProcessoAquecimentoSB.Append(new string('.', Potencia) + " ");
        await InvokeAsync(StateHasChanged); // Atualiza a UI
    }

    private int ConverterTempoEmSegundos()
    {
        int minutos = int.Parse(TempoAtual.Substring(0, 2));
        int segundos = int.Parse(TempoAtual.Substring(2, 2));
        return (minutos * 60) + segundos;
    }

    private string ConverterSegundosParaTempo(int totalSegundos)
    {
        int minutos = totalSegundos / 60;
        int segundos = totalSegundos % 60;
        return minutos.ToString("D2") + segundos.ToString("D2");
    }

    // Alterar a potência
    private void MudarPotencia()
    {
        ExibirPotencia = true;
        Potencia = Potencia >= 10 ? 1 : Potencia + 1;
    }

    private void LimparTempo() => TempoAtual = "0000";

    // Método para adicionar números ao display do micro-ondas
    private void AdicionarNumero(string numero)
    {
        if (ExibirPotencia)
            return;

        TempoAtual = (TempoAtual + numero).Substring(TempoAtual.Length >= 3 ? 1 : 0, 4);
    }
}
